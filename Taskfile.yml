version: '3'

vars:
  ASYNC_PROFILER_DIR: "{{.TASK_DIR}}/.local/async-profiler"
  BENCHMARKS_OUTPUT_DIR: "{{.TASK_DIR}}/target/benchmarks"
  BENCHMARKS_JAR: "mapreduce-perf/target/benchmarks.jar"

tasks:
  download-async-profiler:
    desc: "Install async-profiler (Linux x64)"
    vars:
      ASYNC_PROFILER_VERSION: "4.0"
      ASYNC_PROFILER_URL: "https://github.com/async-profiler/async-profiler/releases/download/v{{.ASYNC_PROFILER_VERSION}}/async-profiler-{{.ASYNC_PROFILER_VERSION}}-linux-x64.tar.gz"
      ASYNC_PROFILER_ARCHIVE: "async-profiler-{{.ASYNC_PROFILER_VERSION}}-linux-x64.tar.gz"
      VERSION_FILE: "{{.ASYNC_PROFILER_DIR}}/.version"
    cmds:
      - curl -L -o {{.ASYNC_PROFILER_ARCHIVE}} {{.ASYNC_PROFILER_URL}}
      - rm -rf {{.ASYNC_PROFILER_DIR}}
      - mkdir -p {{.ASYNC_PROFILER_DIR}}
      - tar xzf {{.ASYNC_PROFILER_ARCHIVE}} --strip-components=1 -C {{.ASYNC_PROFILER_DIR}}
      - echo "{{.ASYNC_PROFILER_VERSION}}" > {{.VERSION_FILE}}
      - rm {{.ASYNC_PROFILER_ARCHIVE}}
    sources:
      - Taskfile.yml
    generates:
      - "{{.ASYNC_PROFILER_DIR}}/lib/libasyncProfiler.so"
    status:
      - test -f "{{.VERSION_FILE}}" && test "$(cat {{.VERSION_FILE}})" = "{{.ASYNC_PROFILER_VERSION}}"
  build:
    desc: "Build the project with Maven"
    cmds:
      - ./mvnw --batch-mode --update-snapshots verify
    sources:
      - "pom.xml"
      - "**/src/main/java/**"
      - "**/src/test/java/**"
    generates:
      - "**/target/classes/**"
      - "**/target/test-classes/**"
  run-benchmarks:
    desc: "Run benchmarks"
    deps:
      - build
    cmds:
      - java -jar mapreduce-perf/target/benchmarks.jar -wi 5 -i 5 -f 1
  parallel-scaling-benchmarks:
    desc: "Run scaling benchmarks for ParallelMapReduceWordCountBenchmark with different thread counts"
    deps:
      - build
    vars:
      RESULTS_FILE: "{{.BENCHMARKS_OUTPUT_DIR}}/parallel-scaling-results.json"
    cmds:
      - mkdir -p {{.BENCHMARKS_OUTPUT_DIR}}
      - |
        java -jar {{.BENCHMARKS_JAR}} \
          "ParallelMapReduceWordCountBenchmark" \
          -p threadPoolMaxSize=2,4,8,16,32,64 \
          -wi 3 -i 5 -f 3 \
          -rf json -rff {{.RESULTS_FILE}}
      - |
        echo "=== Parallel Scaling Benchmark Results ==="
        echo "Threads | Throughput (ops/sec) | Error     "
        echo "--------|---------------------|----------"
        jq -r '.[] | select(.benchmark | contains("countWords")) | "\(.params.threadPoolMaxSize | tostring | .[0:2]) | \(.primaryMetric.score | tostring | .[0:10]) | ±\(.primaryMetric.scoreError | tostring | .[0:6])"' {{.RESULTS_FILE}} | 
        awk -F'|' '{printf "%-7s | %-19s | %-9s\n", $1, $2, $3}'
  batching-scaling-benchmarks:
    desc: "Run scaling benchmarks for BatchingMapReduceWordCountBenchmark with different thread counts"
    deps:
      - build
    vars:
      RESULTS_FILE: "{{.BENCHMARKS_OUTPUT_DIR}}/batching-scaling-results.json"
    cmds:
      - mkdir -p {{.BENCHMARKS_OUTPUT_DIR}}
      - |
        java -jar {{.BENCHMARKS_JAR}} \
          "BatchingMapReduceWordCountBenchmark" \
          -p threadPoolMaxSize=2,4,8,16,32,64 \
          -wi 3 -i 5 -f 3 \
          -rf json -rff {{.RESULTS_FILE}}
      - |
        echo "=== Batching Scaling Benchmark Results ==="
        echo "Threads | Throughput (ops/sec) | Error     "
        echo "--------|---------------------|----------"
        jq -r '.[] | select(.benchmark | contains("countWords")) | "\(.params.threadPoolMaxSize | tostring | .[0:2]) | \(.primaryMetric.score | tostring | .[0:10]) | ±\(.primaryMetric.scoreError | tostring | .[0:6])"' {{.RESULTS_FILE}} | 
        awk -F'|' '{printf "%-7s | %-19s | %-9s\n", $1, $2, $3}'
  scaling-benchmarks:
    deps:
      - parallel-scaling-benchmarks
      - batching-scaling-benchmarks
  profile-benchmarks:
    desc: "Profile benchmarks using async-profiler"
    deps:
      - download-async-profiler
      - build
    cmds:
      - |
        java -jar {{.BENCHMARKS_JAR}} \
        ParallelMapReduceWordCountBenchmark \
        -wi 5 -i 5 -f 1 \
        -p threadPoolMaxSize=2,4,8,16,32,64 \
        -p stopwordsClass="pl.symentis.wordcount.stopwords.ICUThreadLocalStopwords" \
        -prof "async:libPath={{.ASYNC_PROFILER_DIR}}/lib/libasyncProfiler.so;event=wall;output=collapsed;threads=true;dir={{.BENCHMARKS_OUTPUT_DIR}}"
